<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment | GenziKart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>

<body class="antialiased bg-slate-50">
    <!-- Navbar -->
    <nav id="navbar" class="fixed top-0 left-0 right-0 z-50 bg-white transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <div class="flex-shrink-0">
                    <a href="index.html" class="flex items-center">
                        <img src="images/logo.jpg" alt="GENZIKART Logo" class="h-10 w-auto" />
                    </a>
                </div>

                <!-- Desktop Menu -->
                <div class="hidden md:flex items-center space-x-8">
                    <a href="index.html" class="nav-link">Home</a>
                    <a href="products.html" class="nav-link">Products</a>
                    <a href="cart.html" class="nav-link">Cart</a>
                </div>

                <!-- Right Icons -->
                <div class="flex items-center space-x-4">
                    <!-- WhatsApp -->
                    <a href="https://wa.me/9508103997" target="_blank" class="nav-icon" data-testid="whatsapp-icon">
                        <i class="fab fa-whatsapp text-xl text-green-500"></i>
                    </a>

                    <!-- User Profile -->
                    <div class="relative" id="userDropdown">
                        <button class="nav-icon" data-testid="user-profile-btn">
                            <i class="fas fa-user text-xl"></i>
                        </button>
                        <div id="dropdownMenu" class="dropdown-menu w-64 p-0 overflow-hidden">
                            <!-- User Info Section (Only visible when logged in) -->
                            <div id="userLinks" style="display: none;">
                                <div class="bg-gradient-to-br from-slate-50 to-slate-100 p-4 border-b border-slate-100">
                                    <div class="flex items-center gap-3">
                                        <div id="avatarDisplay"
                                            class="text-3xl bg-white w-12 h-12 rounded-full flex items-center justify-center shadow-sm">
                                            üßë‚Äçüíº</div>
                                        <div class="overflow-hidden">
                                            <p class="text-xs font-semibold text-slate-400 uppercase tracking-wider">
                                                Account</p>
                                            <p id="userEmailDisplay" class="text-sm font-bold text-slate-700 truncate">
                                                user@example.com</p>
                                        </div>
                                    </div>
                                    <div
                                        class="avatar-grid flex justify-between mt-3 bg-white/50 p-1 rounded-lg border border-slate-200/50">
                                        <!-- Avatars injected via main.js -->
                                    </div>
                                </div>
                                <div class="p-2">
                                    <a href="profile.html"
                                        class="flex items-center gap-3 px-4 py-2.5 text-sm text-slate-700 hover:bg-amber-50 hover:text-amber-600 rounded-lg transition-colors group">
                                        <i class="fas fa-user-circle text-slate-400 group-hover:text-amber-500"></i>
                                        My Profile
                                    </a>
                                    <a href="my-orders.html"
                                        class="flex items-center gap-3 px-4 py-2.5 text-sm text-slate-700 hover:bg-amber-50 hover:text-amber-600 rounded-lg transition-colors group">
                                        <i class="fas fa-box text-slate-400 group-hover:text-amber-500"></i>
                                        My Orders
                                    </a>
                                    <a href="wishlist.html"
                                        class="flex items-center gap-3 px-4 py-2.5 text-sm text-slate-700 hover:bg-amber-50 hover:text-amber-600 rounded-lg transition-colors group">
                                        <i class="fas fa-heart text-slate-400 group-hover:text-amber-500"></i>
                                        Wishlist
                                    </a>
                                    <hr class="my-2 border-slate-100">
                                    <a href="#" id="logoutBtn"
                                        class="flex items-center gap-3 px-4 py-2.5 text-sm text-red-500 hover:bg-red-50 rounded-lg transition-colors group">
                                        <i class="fas fa-sign-out-alt text-red-400 group-hover:text-red-500"></i>
                                        Logout
                                    </a>
                                </div>
                            </div>

                            <!-- Login Section (Only visible when logged out) -->
                            <div id="authLinks" style="display: block;" class="p-4 text-center">
                                <p class="text-sm text-slate-500 mb-3">Welcome to Genzikart</p>
                                <a href="login.html"
                                    class="block w-full bg-amber-500 text-white py-2 rounded-lg font-bold hover:bg-amber-600 transition-colors shadow-lg shadow-amber-500/30">
                                    Login / Register
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Mobile Menu Toggle -->
                    <button id="mobileMenuBtn" class="md:hidden text-2xl" data-testid="mobile-menu-btn">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Menu -->
        <div id="mobileMenu" class="mobile-menu">
            <a href="index.html" class="mobile-menu-link">Home</a>
            <a href="products.html" class="mobile-menu-link">Products</a>
            <a href="cart.html" class="mobile-menu-link">Cart</a>
        </div>
    </nav>

    <div class="min-h-screen pt-24 pb-12 px-4">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="flex items-center mb-8">
                <a href="address.html" class="text-slate-600 hover:text-slate-800">
                    <i class="fas fa-arrow-left text-2xl"></i>
                </a>
                <h1 class="text-3xl font-bold ml-4">Payment</h1>
            </div>

            <div class="grid lg:grid-cols-3 gap-8">
                <!-- Payment Methods -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Online Payment -->
                    <div class="bg-white rounded-lg shadow-sm p-6" data-testid="online-payment-section">
                        <h2 class="text-xl font-semibold mb-4">Online Payment</h2>
                        <p class="text-sm text-slate-600 mb-4 flex items-center gap-2">
                            <i class="fas fa-shield-alt text-green-600"></i>
                            Secure payment gateway
                        </p>

                        <!-- UPI Options -->
                        <div class="space-y-3">
                            <label class="payment-option" data-testid="gpay-option">
                                <input type="radio" name="payment" value="gpay" class="mr-3">
                                <div class="flex items-center gap-3 flex-1">
                                    <i class="fab fa-google-pay text-3xl"></i>
                                    <span class="font-semibold">Google Pay</span>
                                </div>
                            </label>

                            <label class="payment-option" data-testid="phonepe-option">
                                <input type="radio" name="payment" value="phonepe" class="mr-3">
                                <div class="flex items-center gap-3 flex-1">
                                    <i class="fas fa-mobile-alt text-3xl text-purple-600"></i>
                                    <span class="font-semibold">PhonePe</span>
                                </div>
                            </label>

                            <label class="payment-option" data-testid="paytm-option">
                                <input type="radio" name="payment" value="paytm" class="mr-3">
                                <div class="flex items-center gap-3 flex-1">
                                    <i class="fas fa-wallet text-3xl text-blue-600"></i>
                                    <span class="font-semibold">Paytm</span>
                                </div>
                            </label>

                            <label class="payment-option" data-testid="upi-option">
                                <input type="radio" name="payment" value="upi" class="mr-3">
                                <div class="flex items-center gap-3 flex-1">
                                    <i class="fas fa-qrcode text-3xl"></i>
                                    <span class="font-semibold">Other UPI</span>
                                </div>
                            </label>
                        </div>

                        <!-- UPI ID Input (hidden initially) -->
                        <div id="upiInput" class="hidden mt-4" data-testid="upi-input-field">
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Enter UPI ID</label>
                            <input type="text" placeholder="yourname@upi" class="form-input">
                        </div>

                        <button id="payOnlineBtn"
                            class="w-full mt-6 bg-green-600 text-white py-3 rounded-full font-semibold hover:bg-green-700 transition-colors"
                            data-testid="pay-online-btn">
                            Pay Securely
                        </button>
                    </div>

                    <!-- Cash on Delivery -->
                    <div class="bg-white rounded-lg shadow-sm p-6" data-testid="cod-section">
                        <h2 class="text-xl font-semibold mb-4">Cash on Delivery</h2>

                        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4">
                            <p class="text-sm text-amber-800 font-semibold mb-2">
                                <i class="fas fa-info-circle mr-2"></i>
                                ‚Çπ49 Advance Payment Required
                            </p>
                            <p class="text-sm text-amber-700">
                                This amount is non-refundable and will be deducted from your final bill.
                            </p>
                        </div>

                        <div class="space-y-2 mb-4">
                            <div class="flex justify-between text-sm">
                                <span class="text-slate-600">Order Total</span>
                                <span id="codTotal" class="font-semibold">‚Çπ0</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-slate-600">Advance Payment</span>
                                <span class="font-semibold text-amber-600">‚Çπ49</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-slate-600">Pay on Delivery</span>
                                <span id="remainingAmount" class="font-semibold">‚Çπ0</span>
                            </div>
                        </div>

                        <button id="codBtn"
                            class="w-full bg-amber-500 text-white py-3 rounded-full font-semibold hover:bg-amber-600 transition-colors"
                            data-testid="cod-btn">
                            Pay ‚Çπ49 & Proceed
                        </button>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-sm p-6 sticky top-8" data-testid="order-summary">
                        <h2 class="text-xl font-bold mb-6">Order Summary</h2>

                        <!-- Delivery Address -->
                        <div class="mb-6 pb-6 border-b" data-testid="delivery-address">
                            <h3 class="text-sm font-semibold text-slate-700 mb-2">Deliver to:</h3>
                            <div id="deliveryAddress" class="text-sm text-slate-600">
                                <p class="font-semibold">Loading...</p>
                            </div>
                        </div>

                        <div class="space-y-3 mb-6">
                            <div class="flex justify-between">
                                <span class="text-slate-600">Items</span>
                                <span id="itemCount" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Subtotal</span>
                                <span id="subtotal" class="font-semibold">‚Çπ0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Shipping</span>
                                <span class="text-green-600 font-semibold">FREE</span>
                            </div>
                            <div class="border-t pt-3 flex justify-between text-lg font-bold">
                                <span>Total</span>
                                <span id="total">‚Çπ0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Processing Modal -->
    <div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
        data-testid="payment-modal">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 text-center">
            <div id="processingState" data-testid="processing-state">
                <div
                    class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-slate-200 border-t-amber-500 mb-4">
                </div>
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Processing Payment</h2>
                <p class="text-slate-600">Please wait...</p>
            </div>

            <div id="successState" class="hidden" data-testid="success-state">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-check text-4xl text-green-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Payment Successful!</h2>
                <p class="text-slate-600 mb-4">Your order has been placed successfully.</p>
                <p class="text-sm text-slate-500">Order ID: <span id="orderId" class="font-mono font-semibold"></span>
                </p>
            </div>

            <div id="failureState" class="hidden" data-testid="failure-state">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-times text-4xl text-red-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Payment Failed</h2>
                <p class="text-slate-600 mb-4">Please try again or choose a different payment method.</p>
                <button onclick="closePaymentModal()"
                    class="px-6 py-2 bg-slate-200 rounded-full font-semibold hover:bg-slate-300 transition-colors">
                    Try Again
                </button>
            </div>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            // Load cart summary
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');

            // Fetch products to get real prices
            const responseProducts = await apiFetch('/products');
            const products = responseProducts.products || []; // Extract from nested products array

            const total = cart.reduce((sum, item) => {
                const product = products.find(p => p._id === item.productId);
                return sum + ((product ? product.price : 0) * item.quantity);
            }, 0);

            // Store total globally for use in processPayment if needed
            window.orderTotal = total;

            document.getElementById('itemCount').textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('subtotal').textContent = '‚Çπ' + total.toLocaleString('en-IN');
            document.getElementById('total').textContent = '‚Çπ' + total.toLocaleString('en-IN');
            document.getElementById('codTotal').textContent = '‚Çπ' + total.toLocaleString('en-IN');
            document.getElementById('remainingAmount').textContent = '‚Çπ' + (total - 49).toLocaleString('en-IN');

            // Load delivery address
            const address = JSON.parse(localStorage.getItem('selectedAddress') || '{}');
            if (address.name) {
                const addrLine = [address.line1, address.line2].filter(Boolean).join(', ');
                document.getElementById('deliveryAddress').innerHTML = `
                    <p class="font-semibold text-slate-800">${address.name}</p>
                    <p>${addrLine}</p>
                    <p>${address.city}, ${address.state}</p>
                    <p class="mt-2 text-amber-600 font-medium"><i class="fas fa-phone-alt mr-1"></i> ${address.phone}</p>
                `;
            }

            // Show UPI input when Other UPI is selected
            document.querySelectorAll('input[name="payment"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    if (this.value === 'upi') {
                        document.getElementById('upiInput').classList.remove('hidden');
                    } else {
                        document.getElementById('upiInput').classList.add('hidden');
                    }
                });
            });

            // Online payment
            document.getElementById('payOnlineBtn').addEventListener('click', function () {
                const selectedPayment = document.querySelector('input[name="payment"]:checked');
                if (!selectedPayment) {
                    showToast('Please select a payment method', 'error');
                    return;
                }
                processPayment('online');
            });

            // COD payment
            document.getElementById('codBtn').addEventListener('click', function () {
                processPayment('cod');
            });
        });

        async function processPayment(method) {
            // Show modal
            const modal = document.getElementById('paymentModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            try {
                const cart = JSON.parse(localStorage.getItem('cart') || '[]');
                const address = JSON.parse(localStorage.getItem('selectedAddress') || '{}');
                const token = localStorage.getItem('token');
                const userEmail = localStorage.getItem('userEmail') || "guest@example.com";

                const responseProducts = await apiFetch('/products');
                const products = responseProducts.products || []; // Extract from nested products array

                const orderItems = cart.map(cartItem => {
                    const product = products.find(p => p._id === cartItem.productId);
                    return {
                        productId: cartItem.productId,
                        name: product ? product.name : "Unknown Product",
                        quantity: cartItem.quantity,
                        price: product ? product.price : 0,
                        image: product ? product.image : ""
                    };
                });

                const total = orderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const orderIdStr = 'ORD-' + Math.random().toString(36).substr(2, 6).toUpperCase();

                const orderData = {
                    id: orderIdStr, // Explicit ID for admin panel sync
                    customer: address.name || "Guest",
                    email: userEmail,
                    items: orderItems,
                    total: total,
                    payment: method === 'cod' ? 'COD (Testing)' : 'Paid (Testing)',
                    status: 'Processing',
                    shippingAddress: address,
                    date: new Date().toISOString().split('T')[0]
                };

                const response = await apiFetch('/orders', {
                    method: 'POST',
                    body: JSON.stringify(orderData)
                });

                // Update Success UI with details
                document.getElementById('processingState').classList.add('hidden');
                const successState = document.getElementById('successState');
                successState.classList.remove('hidden');

                successState.innerHTML = `
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-check text-5xl text-green-600"></i>
                    </div>
                    <h2 class="text-2xl font-black text-slate-800 mb-2">Order Confirmed!</h2>
                    <p class="text-slate-500 mb-6 font-medium">Order ID: <span class="text-amber-600 font-black">${orderIdStr}</span></p>
                    
                    <div class="bg-slate-50 rounded-2xl p-6 text-left border border-slate-100 mb-6">
                        <h3 class="font-black text-slate-800 mb-4 flex items-center gap-2 text-sm">
                            <i class="fas fa-receipt text-amber-500"></i> Order Summary
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500 font-bold">Total Amount:</span>
                                <span class="font-black text-slate-800">‚Çπ${total.toLocaleString('en-IN')}</span>
                            </div>
                            <div class="pt-3 border-t border-slate-200">
                                <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Shipping to:</p>
                                <p class="text-xs text-slate-700 font-black">${address.name}</p>
                                <p class="text-[10px] text-slate-500">${address.line1}, ${address.city}</p>
                            </div>
                        </div>
                    </div>

                    <button onclick="window.location.href='index.html'" 
                            class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900 transition-all">
                        Back to Home
                    </button>
                    <p class="mt-4 text-[10px] text-slate-400 font-bold tracking-widest uppercase">Redirecting in 5 seconds...</p>
                `;

                // Clear local cart
                localStorage.removeItem('cart');
                if (typeof updateCartBadge === "function") updateCartBadge();

                // Redirect after delay
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 5000);

            } catch (error) {
                console.error("Payment Error:", error);
                document.getElementById('processingState').classList.add('hidden');
                document.getElementById('failureState').classList.remove('hidden');
            }
        }

        function closePaymentModal() {
            const modal = document.getElementById('paymentModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('processingState').classList.remove('hidden');
            document.getElementById('successState').classList.add('hidden');
            document.getElementById('failureState').classList.add('hidden');
        }
    </script>
</body>

</html>
